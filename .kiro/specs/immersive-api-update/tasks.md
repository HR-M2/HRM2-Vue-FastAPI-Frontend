# 实施计划: 沉浸式面试API更新

## 概述

本实施计划专注于更新沉浸式面试系统的业务逻辑以适配新的后端API，同时保持现有UI样式不变。主要工作集中在测试验证和API集成验证。

**当前状态**: 核心功能已实现，需要添加测试框架和验证API集成。

## 任务

- [x] 1. 更新API客户端和数据类型定义
  - [x] 更新 `useImmersiveInterview.ts` 中的API端点常量
  - [x] 添加新的数据类型定义以匹配新API规范
  - [x] 更新现有接口以支持新的数据结构
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 2. 实现批量数据同步机制
  - [x] 2.1 创建数据同步管理器类
    - [x] 实现 `DataSyncManager` 类用于批量数据处理
    - [x] 添加同步队列和定时器机制
    - [x] 实现数据批量打包逻辑
    - _需求: 2.1, 2.2, 2.3, 2.4_

  - [x] 2.2 集成同步管理器到 composable
    - [x] 在 `useImmersiveInterview` 中集成 `DataSyncManager`
    - [x] 更新现有的数据添加方法以使用批量同步
    - [x] 实现自动同步和手动同步触发
    - _需求: 2.1, 2.5_

- [x] 3. 实现智能问题建议功能
  - [x] 3.1 添加问题建议API调用
    - [x] 实现 `fetchQuestionSuggestions` 方法
    - [x] 添加问题建议的数据类型和接口
    - [x] 集成心理上下文和对话历史参数
    - _需求: 3.1, 3.2_

  - [x] 3.2 实现降级机制
    - [x] 添加AI服务失败时的本地问题生成
    - [x] 实现基于简历的问题建议生成
    - [x] 添加错误处理和降级逻辑
    - _需求: 3.5_

- [x] 4. 实现实时洞察功能
  - [x] 4.1 添加洞察API调用和数据处理
    - [x] 实现 `fetchInsights` 方法
    - [x] 添加洞察数据的类型定义
    - [x] 实现洞察数据的状态管理
    - _需求: 4.1, 4.2_

  - [x] 4.2 集成洞察显示逻辑
    - [x] 更新现有的洞察显示机制
    - [x] 实现关键警报的处理逻辑
    - [x] 添加质量指标的实时更新
    - _需求: 4.3, 4.4, 4.5_

- [x] 5. 实现会话完成和数据检索功能
  - [x] 5.1 更新会话完成逻辑
    - [x] 实现新的 `completeSession` 方法调用 `/complete` 端点
    - [x] 处理完整会话数据的接收和解析
    - [x] 更新会话完成后的数据显示逻辑
    - _需求: 5.1, 5.2, 5.3_

  - [x] 5.2 实现数据导出功能
    - [x] 更新数据导出方法以包含完整的心理分析数据
    - [x] 添加导出失败时的重试机制
    - [x] 确保导出数据包含所有对话历史
    - _需求: 5.4, 5.5_

- [x] 6. 实现心理分析功能开关
  - [x] 6.1 添加心理分析配置管理
    - [x] 在 composable 中添加心理分析开关状态
    - [x] 实现配置更改的响应逻辑
    - [x] 添加配置持久化机制
    - _需求: 11.1, 11.5_

  - [x] 6.2 集成心理分析开关到API调用
    - [x] 更新问题建议API调用以根据配置设置心理上下文参数
    - [x] 实现心理状态显示的条件逻辑
    - [x] 确保配置更改立即生效
    - _需求: 11.2, 11.3, 11.4_

- [x] 7. 实现错误处理和性能优化
  - [x] 7.1 添加综合错误处理机制
    - [x] 实现 `APIErrorHandler` 类
    - [x] 添加指数退避重试逻辑
    - [x] 实现网络错误、认证失败等场景的处理
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [x] 7.2 实现性能优化
    - [x] 优化批量同步的负载大小和频率
    - [x] 实现实时数据处理的性能优化
    - [x] 添加内存管理和清理机制
    - _需求: 8.1, 8.2, 8.4_

- [x] 8. 最终集成和UI更新
  - [x] 8.1 集成所有功能到现有 composable
    - [x] 确保所有新功能与现有UI组件正确集成
    - [x] 验证数据流和状态管理的正确性
    - [x] 测试完整的面试流程
    - _需求: 所有需求_

## 剩余任务 - 测试和验证

- [ ] 9. 设置测试框架
  - [ ] 9.1 安装和配置Vitest测试框架
    - 安装 vitest, @vitest/ui, jsdom 等测试依赖
    - 创建 vitest.config.ts 配置文件
    - 更新 package.json 添加测试脚本
    - _需求: 所有需求的测试验证_

  - [ ] 9.2 配置Vue组件测试环境
    - 安装 @vue/test-utils 用于Vue组件测试
    - 配置测试环境支持TypeScript和Vue SFC
    - 设置测试覆盖率报告
    - _需求: 所有需求的测试验证_

- [ ] 10. 编写属性测试
  - [ ] 10.1 为API端点调用正确性编写属性测试
    - **属性 1: API端点调用正确性**
    - **验证需求: 1.1, 1.2, 1.3, 1.4, 1.5**

  - [ ] 10.2 为批量数据同步编写属性测试
    - **属性 2: 批量数据同步一致性**
    - **验证需求: 2.1, 2.2, 2.3, 2.4, 2.5**

  - [ ] 10.3 为智能问题建议编写属性测试
    - **属性 3: 智能问题建议功能完整性**
    - **属性 4: 问题建议显示和跟踪**
    - **验证需求: 3.1, 3.2, 3.3, 3.4, 3.5**

  - [ ] 10.4 为实时洞察功能编写属性测试
    - **属性 5: 实时洞察功能正确性**
    - **属性 6: 关键警报处理**
    - **验证需求: 4.1, 4.2, 4.3, 4.4, 4.5**

  - [ ] 10.5 为会话完成功能编写属性测试
    - **属性 7: 会话完成数据完整性**
    - **属性 8: 数据导出和错误恢复**
    - **验证需求: 5.1, 5.2, 5.3, 5.4, 5.5**

  - [ ] 10.6 为数据结构一致性编写属性测试
    - **属性 9: 标准化数据结构一致性**
    - **验证需求: 6.1, 6.2, 6.3, 6.4, 6.5**

  - [ ] 10.7 为错误处理编写属性测试
    - **属性 10: 错误处理和恢复机制**
    - **验证需求: 7.1, 7.2, 7.3, 7.4, 7.5**

  - [ ] 10.8 为性能优化编写属性测试
    - **属性 11: 性能优化综合性**
    - **验证需求: 8.1, 8.2, 8.3, 8.4, 8.5**

  - [ ] 10.9 为心理分析开关编写属性测试
    - **属性 14: 心理分析功能开关控制**
    - **验证需求: 11.2, 11.3, 11.4, 11.5**

- [ ] 11. API集成验证
  - [ ] 11.1 验证新API端点连接
    - 测试所有新API端点的连通性
    - 验证请求和响应格式的正确性
    - 确保错误处理机制正常工作
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

  - [ ] 11.2 验证批量同步功能
    - 测试批量数据同步的完整流程
    - 验证重试机制和错误恢复
    - 确保数据一致性和性能表现
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

  - [ ] 11.3 验证智能功能集成
    - 测试问题建议API的调用和响应
    - 验证洞察API的数据处理
    - 确保降级机制正常工作
    - _需求: 3.1, 3.2, 3.5, 4.1, 4.2, 4.5_

- [ ] 12. 端到端测试
  - [ ] 12.1 完整面试流程测试
    - 测试从创建会话到完成会话的完整流程
    - 验证所有数据同步和API调用
    - 确保UI和业务逻辑的正确集成
    - _需求: 所有需求_

  - [ ] 12.2 错误场景测试
    - 测试网络错误、API失败等异常场景
    - 验证错误处理和用户提示
    - 确保系统的健壮性和用户体验
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ] 13. 最终验证检查点
  - 确保所有属性测试通过
  - 验证API集成正常工作
  - 确认端到端流程无问题
  - 如有问题请询问用户

## 注意事项

- 标记为 `*` 的任务是可选的，可以跳过以实现更快的MVP
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证具体示例和边界情况
- **重要**: 保持现有UI组件和样式不变，只更新业务逻辑层